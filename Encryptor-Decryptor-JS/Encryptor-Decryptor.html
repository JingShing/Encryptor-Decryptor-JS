<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encryptor-Decryptor</title>
    <style>
        button {
        background-color: black;
        color: white;
        }
    </style>
</head>
<body>
    <p>This tool is made by <a href="https://github.com/JingShing">JingShing</a>.</p>
    <p>You can drag your file in the content or key to input the text. It is allow to use txt, jpg and png file.</p>
    <p>You can also click content or key title to select file.</p>
    <p>這個工具由 <a href="https://github.com/JingShing">JingShing</a> 製作</p>
    <p>可以拖曳檔案到 content 欄，目前支持 txt, jpg 和 png 檔。將 key 輸入後：按 Encrypt 加密；Decrypt 解密。</p>
    <p>也可以點擊 content 或 key 的標題選擇檔案。</p>
    <form id = "all_file_input">
        <input type="file" id="fileInput_content" style="display:none">
        <p><label for="fileInput_content">Content(Select File):</label></p>
        <textarea id="content" rows="10" cols="50"></textarea>
        <br>
        <input type="file" id="fileInput_key" style="display:none">
        <p><label for="fileInput_key">Key(Select File):</label></p>
        <textarea id="key" rows="10" cols="50"></textarea>
        <br>
        <button onclick="encrypt_button();return false;">Encrypt</button>
        <button onclick="decrypt_button();return false;">Decrypt</button>
        <p><label>Output</label></p>
        <br>
        <textarea id="output" rows="10" cols="50"></textarea>
        <br>
        
        Preview：<br>
        <img id="preview" >
        <br>
        Compressed Image：<span id="sz"></span><br>
        <img id="pic" >
      </form>
</body>
<script>

function encrypt_button(){
    let line = document.getElementById("content").value;
    let key = document.getElementById("key").value;
    document.getElementById("output").value = encrypt(line, key);
}
function decrypt_button(){
    let line = document.getElementById("content").value;
    let key = document.getElementById("key").value;
    document.getElementById("output").value = decrypt(line, key);
}

function key_line_len(line, key) {
  if (key.length > 0) {
    while (key.length < line.length) {
      key += key;
    }
  } else {
    key = key_line_len(line, 'RRR'); // default key
  }
  return key;
}

// encryption
function encrypt(line, key) {
    key = key_line_len(line, key);
    let en_str = "";
    for (let i = 0; i < line.length; i++) {
    const j = key[i]; // i is data, j is key
    const temp = String.fromCharCode(line.charCodeAt(i) + j.charCodeAt(0)); // encryption character = character Unicode + key Unicode
    en_str += temp;
    }
    const s1 = btoa(en_str);
    // setBase64Image(s1);
    return s1;
}

// decryption
function decrypt(line, key) {
    key = key_line_len(line, key);
    const p = atob(line);
    let de_str = "";
    for (let i = 0; i < p.length; i++) {
        const j = key[i]; // i is data, j is key
        const temp = String.fromCharCode(p.charCodeAt(i) - j.charCodeAt(0)); // decryption = (encryption Unicode character - key Unicode) character
        de_str += temp;
    }
    setBase64Image(de_str);
    generateBlurPreviewBase(de_str, -1, -1, 0.2, 2)
    return de_str;
}

function list_encrypt(data, key) {
  const en_list = [];
  for (const line of data) {
    en_list.push(encrypt(line, key));
  }
  return en_list;
}

function list_decrypt(data, key) {
  const de_list = [];
  for (const line of data) {
    de_list.push(decrypt(line, key));
  }
  return de_list;
}

// drag and drop
function handleDragOver(evt) {
      evt.stopPropagation();
      evt.preventDefault();
      evt.dataTransfer.dropEffect = 'copy';
    }
var dropZone = document.querySelector('#content');
dropZone.addEventListener('dragover', handleDragOver, false);
dropZone.addEventListener('drop', handleFileSelect, false);

var fileInput = document.querySelector('#fileInput_content');
fileInput.addEventListener('change', handleFileSelect, false);

var dropZone2 = document.querySelector('#key');
dropZone2.addEventListener('dragover', handleDragOver, false);
dropZone2.addEventListener('drop', handleFileSelect, false);

var fileInput2 = document.querySelector('#fileInput_key');
fileInput2.addEventListener('change', handleFileSelect, false);


function handleFileSelect(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    var new_id = "";
    var old_id = String(event.target.id);
    if(old_id.includes("fileInput")){
        var file = evt.target.files[0];
        if(old_id.includes("content"))new_id = "content";
        else if(old_id.includes("key"))new_id = "key";
    }
    else{
        var file = evt.dataTransfer.files[0];
        new_id = old_id;
    }
    var file_name = file.name;

    if(file_name.includes(".png")||file_name.includes(".jpg")){
        cutImageBase64(file, null, 900, 0.7, new_id);
        generateBlurPreviewFile(file, -1, -1, 0.2, 2);
    }
    else{
        var reader = new FileReader();
        reader.onload = function(event) {
            document.getElementById(new_id).value = event.target.result;
        };
        reader.readAsText(file);
    }
    clearAllInput();
}
function clearAllInput(){
var inputs = document.getElementsByTagName("input");
    for (var i = 0; i < inputs.length; i++) {
        inputs[i].value = "";
    }
}

// image
function cutImageBase64(m_this,id,wid,quality, output_id) {
    var file = m_this;
    var URL = window.URL || window.webkitURL;
    var blob = URL.createObjectURL(file);
    var base64;
    var img = new Image();
    img.src = blob;
    img.onload = function() {
        var that = this;
        //size
        var w = that.width,
            h = that.height,
            scale = w / h;
            w = wid || w;
            h = w / scale;
        //generate canvas
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        canvas.width = w;
        canvas.height = h;
        ctx.drawImage(that, 0, 0, w, h);
        // generate base64
        if(file.name.includes('.jpg'))base64 = canvas.toDataURL('image/jpeg', quality || 0.9);
        else if(file.name.includes('.png'))base64 = canvas.toDataURL('image/png', quality || 0.9);
        document.getElementById(output_id).value = base64;
    };
}
function setBase64Image(base64){
    document.getElementById("pic").src=base64;
    document.getElementById("sz").innerHTML = parseInt(base64.length/2014,0) + "kb";
}
function generateBlurPreviewFile(file, width, height, quality, scale) {
    output_id = "preview";
    // quality is 0~1
    // scale 1 means normal, 2 means 1/2 size
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = function (event) {
    const img = new Image();
    img.src = event.target.result;
    img.onload = function () {
        if (width==-1 && height == -1){
            const canvas = document.createElement('canvas');
            canvas.width = img.width/scale;
            canvas.height = img.height/scale;
            const ctx = canvas.getContext('2d');
            ctx.filter = 'blur(5px)';
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            // return the preview as a base64 string
            const preview = canvas.toDataURL('image/jpeg', quality);
            document.getElementById(output_id).src = preview;
        }
        else{
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.filter = 'blur(5px)';
            ctx.drawImage(img, 0, 0, width, height);
            // return the preview as a base64 string
            const preview = canvas.toDataURL('image/jpeg', quality);
            document.getElementById(output_id).src = preview;
        }
    };
  };
}
function generateBlurPreviewBase(base64String, width, height, quality, scale) {
  output_id = "preview";
  // quality is 0~1
  // scale 1 means normal, 2 means 1/2 size
  const img = new Image();
  img.src = base64String;
  img.onload = function () {
    if (width == -1 && height == -1) {
      const canvas = document.createElement("canvas");
      canvas.width = img.width / scale;
      canvas.height = img.height / scale;
      const ctx = canvas.getContext("2d");
      ctx.filter = "blur(5px)";
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      // return the preview as a base64 string
      const preview = canvas.toDataURL("image/jpeg", quality);
      document.getElementById(output_id).src = preview;
    } else {
      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.filter = "blur(5px)";
      ctx.drawImage(img, 0, 0, width, height);
      // return the preview as a base64 string
      const preview = canvas.toDataURL("image/jpeg", quality);
      document.getElementById(output_id).src = preview;
    }
  };
}

</script>
</html>
